import{execaSync as t,execa as o}from"execa";import{cwd as r,chdir as e}from"node:process";import i from"node:readline";import{stat as s}from"node:fs/promises";import n from"node:path";import c from"ora";const m=n.resolve();let a=c("");const u=async({branch:i,master:c,npmScript:u,customCommit:l,debug:d,dist:p,shortCommitHash:g})=>{const f=({removeBuildDir:o=!1}={})=>{try{e(m),t("git",["worktree","remove","-f","-f",i]),t("git",["worktree","prune"]),o&&(t("rm",["-rf","build"]),d&&console.log("buildä¸´æ—¶ç›®å½•å·²åˆ é™¤\n"))}catch(t){}},{stdout:h}=await o("git",["symbolic-ref","--short","-q","HEAD"]);if(process.on("SIGINT",process.exit).on("uncaughtException",(t=>{a.fail((d?"è°ƒè¯•":"æ‰“åŒ…æˆ–éƒ¨ç½²")+"æ„å¤–é€€å‡ºï¼Œé‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š\n"),console.log(t),process.exit()})).on("exit",(()=>{f({removeBuildDir:!0}),t("exit",[1])})),c&&c!==h)return console.log(`è¯·åˆ‡æ¢åˆ° ${c} åˆ†æ”¯åŽå†è¿›è¡Œæ‰“åŒ…ã€‚`),void t("exit",[1]);a.text=`å¼€å§‹${d?"è°ƒè¯•":"æ‰“åŒ…éƒ¨ç½²"}...`,a.start();try{await s(n.join(m,"build"))}catch(o){t("mkdir",["build"]),d&&(a.text=`å·²åœ¨${r()}ä¸‹å»ºç«‹ä¸´æ—¶ç›®å½•build\n`)}finally{f();const{stdout:r}=await o("git",["worktree","add","-B",i,`build/${i}`,`origin/${i}`]);console.log(r),e(`build/${i}`),t("rm",["-rf","*"]),e(m)}a.text=`æ­£åœ¨è¿è¡Œæ‰“åŒ…è„šæœ¬... npm run ${u}`;const{stdout:$,stderr:b}=await o("npm",["run",u]);console.log(b+"\n",$),t("cp",["-rf",`${p}/*`,`build/${i}`]),e(`build/${i}`),d&&console.log(`gitæ“ä½œå‰çš„å·¥ä½œç›®å½•${r()}`),a.text="æ‰“åŒ…å®Œæˆï¼Œå‡†å¤‡gitå‘å¸ƒ";const{stdout:x}=await(v=h,o("git",["rev-parse",...g?["--short"]:[],v]));var v;if(l)var w=l({branch:i,currentSrcBranch:h});const C=`built by [ ${w||`srcBranch:${h}`} ] [ commit-hash:${x} ]`;if(t("git",["add","-A"]),t("git",["commit","-m",C]),d)return void a.succeed(`è°ƒè¯•å®Œæˆï¼Œ${l?`å› å¼€å¯äº†customCommitï¼Œæœ¬æ¬¡è‡ªå®šä¹‰æäº¤ä¿¡æ¯ä¸º${C}`:""}è°ƒè¯•æ¨¡å¼ä¸‹ä¸ä¼šæŽ¨é€ä»£ç ï¼Œè¯·æŸ¥çœ‹æœ¬åœ°${i}åˆ†æ”¯çš„è®°å½•è¿›è¡ŒéªŒè¯ã€‚`);const{stdout:y}=t("git",["push","-f","origin",i]);console.log(y),a.succeed(`ä»£ç æŽ¨é€æˆåŠŸï¼Œæœ¬æ¬¡æŽ¨é€çš„gitæäº¤ä¿¡æ¯ä¸ºï¼š${C}ï¼Œæ‰“åŒ…åˆ†æ”¯ä¸º${i}`)};function l({branch:t="release",dist:o="dist",master:r="master",debug:e=!1,npmScript:s,customCommit:n=null,shortCommitHash:c=!0}){if(console.log("[43m%s[0m",`å½“å‰è¿è¡Œæ¨¡å¼ä¸ºï¼š${e?"ã€ è°ƒè¯•ï¼ˆæ‰“åŒ…åŽä¸æŽ¨é€) ã€‘":"ã€ å®Œå…¨ï¼ˆæ‰“åŒ…åŽæŽ¨é€ï¼‰ ã€‘"},å¦‚éœ€æ”¹æˆ${e?"å®Œå…¨":"è°ƒè¯•ï¼ˆæ‰“åŒ…åŽä¸æŽ¨é€ï¼‰"}æ¨¡å¼ï¼Œè¯·å°†debugå‚æ•°è®¾ç½®ä¸º${e?"false":"true"}\n`),"string"==typeof t)return void u({branch:t,master:r,npmScript:s,customCommit:n,shortCommitHash:c,debug:e,dist:o});const m=[];for(const o in t)m.push(`${o}.${t[o].name}`);let a=i.createInterface({input:process.stdin,output:process.stdout});console.log("æ‰€æœ‰çš„æž„å»ºåˆ†æ”¯(all packaging branches)ï¼š\n"+m.join("\n")),a.question("è¯·é€‰æ‹©ä¸€ä¸ªæž„å»ºåˆ†æ”¯ï¼ˆåºå·ï¼‰ï¼š\n",(async o=>{console.log("æ‚¨é€‰æ‹©äº†ï¼š",t[o].name+"åˆ†æ”¯\n"),await u({branch:t[o].name,dist:t[o].dist||"dist",npmScript:t[o].npmScript,master:r,customCommit:n,debug:e,shortCommitHash:c}),a.close()}))}export{l as default};
