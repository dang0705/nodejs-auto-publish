import{execa as o,execaSync as t}from"execa";import e from"copy";import{cwd as s,chdir as r}from"node:process";import i from"node:fs";import n from"node:readline";import{stat as c}from"node:fs/promises";import a from"node:path";import l from"ora";const m=a.resolve();let d=l("");const{stdout:u}=await o("git",["symbolic-ref","--short","-q","HEAD"]),g=o=>{console.log(`è¯·åˆ‡æ¢åˆ°${o}åˆ†æ”¯è¿›è¡Œæ‰“åŒ…ã€‚\nPlease checkout ${o} for release build.`),t("exit",[1])},p=async({branch:n,npmScript:l,customCommit:g,debug:p,dist:f,shortCommitHash:$})=>{const h=async o=>{r(m);const e=async()=>{try{console.log("æ¸…ç†worktree"),t("git",["worktree","remove","-f","-f",n]),t("git",["worktree","prune"]),i.rmdir("./build",(t=>{t&&console.log(t),o&&o()}))}catch(o){}};if(p)o||e();else try{const{stdout:o}=t("git",["worktree","list"]);o.split("\n").forEach((o=>{o.substring(o.indexOf("[")+1,o.indexOf("]"))===n?console.log(`å·²å»ºç«‹${n}`):console.log(`å°šæœªå»ºç«‹${n}`)})),e()}catch(o){console.log(o)}};process.on("SIGINT",process.exit).on("uncaughtException",(o=>{d.fail((p?"è°ƒè¯•":"æ‰“åŒ…æˆ–éƒ¨ç½²")+"æ„å¤–é€€å‡ºï¼Œé‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š\n"),console.log(o),process.exit()})).on("exit",(async()=>{console.log("æ‰§è¡Œæ¸…ç†"),h((()=>o("exit",[1])))})),d.text=`å¼€å§‹${p?"è°ƒè¯•":"æ‰“åŒ…éƒ¨ç½²"}...`,d.start();try{await c(a.join(m,"build"))}catch(o){i.mkdir("build",(()=>p&&(d.text=`å·²åœ¨${s()}ä¸‹å»ºç«‹ä¸´æ—¶ç›®å½•build\n`)))}finally{await h();const{stdout:t}=await o("git",["worktree","add","-B",n,`build/${n}`,`origin/${n}`]);console.log(t);i.readdirSync(`build/${n}`).forEach((o=>".git"!==o&&i.rm(`build/${n}/${o}`,(o=>o&&console.log(o)))))}d.text=`æ­£åœ¨è¿è¡Œæ‰“åŒ…è„šæœ¬... npm run ${l}`;const{stdout:b,stderr:y}=await o("npm",["run",l]);console.log(y+"\n",b);e([`${f}/`,`${f}/**/*`],`build/${n}`,{flatten:!1},(async()=>{r(`build/${n}`),p&&(console.log(`\ngitæ“ä½œå‰çš„å·¥ä½œç›®å½•${s()}`),i.readdir(`build/${n}`,((o,t)=>{console.log(t)}))),d.text="æ‰“åŒ…å®Œæˆï¼Œå‡†å¤‡gitå‘å¸ƒ";const{stdout:e}=await(c=u,o("git",["rev-parse",...$?["--short"]:[],c]));var c;if(g)var a=g({branch:n,currentSrcBranch:u});const l=`built by [ ${a||`srcBranch:${u}`} ] [ latest-src-commit:${e} ]`;t("git",["add","-A"]),t("git",["commit","-m",l]),p?d.succeed(`è°ƒè¯•å®Œæˆï¼Œ${g?`å› å¼€å¯äº†customCommitï¼Œæœ¬æ¬¡è‡ªå®šä¹‰æäº¤ä¿¡æ¯ä¸º${l}`:""}è°ƒè¯•æ¨¡å¼ä¸‹ä¸ä¼šæŽ¨é€ä»£ç ï¼Œè¯·æŸ¥çœ‹æœ¬åœ°${n}åˆ†æ”¯çš„è®°å½•è¿›è¡ŒéªŒè¯ã€‚`):(o("git",["push","-f","origin",n]),d.succeed(`ä»£ç æŽ¨é€æˆåŠŸï¼Œæœ¬æ¬¡æŽ¨é€çš„gitæäº¤ä¿¡æ¯ä¸ºï¼š${l}ï¼Œæ‰“åŒ…åˆ†æ”¯ä¸º${n}`))}))};function f({branch:o="release",dist:t="dist",master:e="master",debug:s=!1,npmScript:r,customCommit:i=null,shortCommitHash:c=!0}){if(console.log("[43m%s[0m",`å½“å‰è¿è¡Œæ¨¡å¼ä¸ºï¼š${s?"ã€ è°ƒè¯•ï¼ˆæ‰“åŒ…åŽä¸æŽ¨é€) ã€‘":"ã€ å®Œå…¨ï¼ˆæ‰“åŒ…åŽæŽ¨é€ï¼‰ ã€‘"},å¦‚éœ€æ”¹æˆ${s?"å®Œæ•´":"è°ƒè¯•ï¼ˆæ‰“åŒ…åŽä¸æŽ¨é€ï¼‰"}æ¨¡å¼ï¼Œè¯·å°†debugå‚æ•°è®¾ç½®ä¸º${s?"false":"true"}\n`),"string"==typeof o)return e&&e!==u?void g(e):void p({branch:o,npmScript:r,customCommit:i,shortCommitHash:c,debug:s,dist:t});const a=[];for(const t in o)a.push(`${t}.${o[t].name}`);let l=n.createInterface({input:process.stdin,output:process.stdout});console.log("æ‰€æœ‰çš„æž„å»ºåˆ†æ”¯(all packaging branches)ï¼š\n"+a.join("\n")),l.question("è¯·é€‰æ‹©ä¸€ä¸ªæž„å»ºåˆ†æ”¯ï¼ˆåºå·ï¼‰ï¼š\n",(async t=>{if(o[t].master&&o[t].master!==u)return g(o[t].master),void l.close();console.log("æ‚¨é€‰æ‹©äº†ï¼š",o[t].name+"åˆ†æ”¯\n"),await p({branch:o[t].name,dist:o[t].dist||"dist",npmScript:o[t].npmScript,customCommit:i,debug:s,shortCommitHash:c}),l.close()}))}export{f as default};
