import{execa as t,execaSync as o}from"execa";import r from"copy";import{cwd as e,chdir as s}from"node:process";import i from"node:fs";import n from"node:readline";import{stat as c}from"node:fs/promises";import a from"node:path";import m from"ora";import l from"rimraf";const d=a.resolve();let u=m("");const{stdout:p}=await t("git",["symbolic-ref","--short","-q","HEAD"]),g=t=>{console.log(`è¯·åˆ‡æ¢åˆ°${t}åˆ†æ”¯è¿›è¡Œæ‰“åŒ…ã€‚\nPlease checkout ${t} for release build.`),o("exit",[1])},f=async({branch:n,npmScript:m,customCommit:g,debug:f,dist:$,shortCommitHash:b})=>{const h={async add(){const{stdout:o}=await t("git",["worktree","add","-B",n,`build/${n}`,`origin/${n}`]);return o},exists(){const{stdout:t}=o("git",["worktree","list"]);return t.split("\n").some((t=>t.substring(t.indexOf("[")+1,t.indexOf("]"))===n))},clear(t=null){s(d);const r=()=>{try{o("git",["worktree","remove","-f","-f",n]),o("git",["worktree","prune"]),i.rmdir("./build",(o=>{o&&console.log(o),t&&t()}))}catch(t){}};f?t||r():this.exists()&&r()}};process.on("SIGINT",process.exit).on("uncaughtException",(t=>{u.fail((f?"è°ƒè¯•":"æ‰“åŒ…æˆ–éƒ¨ç½²")+"æ„å¤–é€€å‡ºï¼Œé‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š\n"),console.log(t),process.exit()})).on("exit",(()=>h.clear((()=>process.kill())))),u.text=`å¼€å§‹${f?"è°ƒè¯•":"æ‰“åŒ…éƒ¨ç½²"}...`,u.start();try{await c(a.join(d,"build"))}catch(t){i.mkdir("build",(()=>f&&(u.text=`å·²åœ¨${e()}ä¸‹å»ºç«‹ä¸´æ—¶ç›®å½•build\n`)))}finally{await h.clear(),console.log(await h.add());i.readdirSync(`build/${n}`).forEach((t=>".git"!==t&&l(`build/${n}/${t}`)))}u.text=`æ­£åœ¨è¿è¡Œæ‰“åŒ…è„šæœ¬... npm run ${m}`;const{stdout:x,stderr:w}=await t("npm",["run",m]);console.log(w+"\n",x),r([`${$}/`,`${$}/**/*`],`build/${n}`,{flatten:!1},(async()=>{s(`build/${n}`),u.text="æ‰“åŒ…å®Œæˆï¼Œå‡†å¤‡gitå‘å¸ƒ",f&&(console.log(`\nå·²å°†ä¸‹åˆ—æ–‡ä»¶ä»Žæ‰“åŒ…ç›®å½• ${$} ç§»è‡³å‘å¸ƒç›®å½• build/${n}ï¼š\n`),i.readdir(`build/${n}`,((t,o)=>console.log(o))));const{stdout:r}=await(e=p,t("git",["rev-parse",...b?["--short"]:[],e]));var e;const c=`built by [ ${g?g({branch:n,currentSrcBranch:p}):`srcBranch:${p}`} ] [ latest-src-commit: ${r} ]`;o("git",["add","-A"]),o("git",["commit","-m",c]),f?u.succeed(`è°ƒè¯•å®Œæˆï¼Œ${g?`å› å¼€å¯äº†customCommitï¼Œæœ¬æ¬¡è‡ªå®šä¹‰æäº¤ä¿¡æ¯ä¸º${c}`:""}è°ƒè¯•æ¨¡å¼ä¸‹ä¸ä¼šæŽ¨é€ä»£ç ï¼Œè¯·æŸ¥çœ‹æœ¬åœ°${n}åˆ†æ”¯çš„è®°å½•è¿›è¡ŒéªŒè¯ã€‚`):(t("git",["push","-f","origin",n]),u.succeed(`ä»£ç æŽ¨é€æˆåŠŸï¼Œæœ¬æ¬¡æŽ¨é€çš„gitæäº¤ä¿¡æ¯ä¸ºï¼š${c}ï¼Œæ‰“åŒ…åˆ†æ”¯ä¸º${n}`))}))};function $({branch:t="release",dist:o="dist",master:r="master",debug:e=!1,npmScript:s,customCommit:i=null,shortCommitHash:c=!0}){if(console.log("[43m%s[0m",`å½“å‰è¿è¡Œæ¨¡å¼ä¸ºï¼š${e?"ã€ è°ƒè¯•ï¼ˆæ‰“åŒ…åŽä¸æŽ¨é€) ã€‘":"ã€ æ­£å¸¸ï¼ˆæ‰“åŒ…åŽæŽ¨é€ï¼‰ ã€‘"},å¦‚éœ€æ”¹æˆ${e?"å®Œæ•´":"è°ƒè¯•ï¼ˆæ‰“åŒ…åŽä¸æŽ¨é€ï¼‰"}æ¨¡å¼ï¼Œè¯·å°†debugå‚æ•°è®¾ç½®ä¸º${e?"false":"true"}\n`),"string"==typeof t)return r&&r!==p?void g(r):void f({branch:t,npmScript:s,customCommit:i,shortCommitHash:c,debug:e,dist:o});const a=[];for(const o in t)a.push(`${o}.${t[o].name}`);let m=n.createInterface({input:process.stdin,output:process.stdout});console.log("æ‰€æœ‰çš„æž„å»ºåˆ†æ”¯(all packaging branches)ï¼š\n"+a.join("\n")),m.question("è¯·é€‰æ‹©ä¸€ä¸ªæž„å»ºåˆ†æ”¯ï¼ˆåºå·ï¼‰ï¼š\n",(async o=>{if(t[o].master&&t[o].master!==p)return g(t[o].master),void m.close();console.log("æ‚¨é€‰æ‹©äº†ï¼š",t[o].name+"åˆ†æ”¯\n"),await f({branch:t[o].name,dist:t[o].dist||"dist",npmScript:t[o].npmScript,customCommit:i,debug:e,shortCommitHash:c}),m.close()}))}export{$ as default};
